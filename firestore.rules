rules_version = "2";

service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    // User is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // User owns the document (via userId field)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Document has userId field matching authenticated user
    function belongsToUser() {
      return isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Incoming data will have correct userId
    function hasValidUserId() {
      return isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // ==================== LEGACY RECORDINGS (ROOT LEVEL) ====================
    match /recordings/{recordingId} {
      allow read: if belongsToUser();
      allow create: if hasValidUserId();
      allow update: if belongsToUser() && request.resource.data.userId == resource.data.userId;
      allow delete: if belongsToUser();
    }

    // ==================== USER-SCOPED COLLECTIONS ====================
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);

      // User profile
      match /profile/{profileId} {
        allow read, write: if isOwner(userId);
      }

      // Recordings (user-scoped)
      match /recordings/{recordingId} {
        allow read, write: if isOwner(userId);
      }

      // Checkpoints
      match /checkpoints/{checkpointId} {
        allow read, write: if isOwner(userId);
      }

      // Conversations
      match /conversations/{conversationId} {
        allow read, write: if isOwner(userId);
      }

      // Daily summaries
      match /dailySummaries/{date} {
        allow read, write: if isOwner(userId);
      }

      // Calendar
      match /calendar/{calendarId} {
        allow read, write: if isOwner(userId);
      }

      // Action items (legacy name)
      match /actionItems/{actionId} {
        allow read, write: if isOwner(userId);
      }

      // Actions (Manus-enriched action items)
      match /actions/{actionId} {
        allow read, write: if isOwner(userId);
      }

      // Integrations (Manus, etc.)
      match /integrations/{integrationId} {
        allow read: if isOwner(userId);
        // Write only from Cloud Functions (admin SDK bypasses rules)
        // Users should not write API keys directly from frontend
        allow write: if false;
      }

      // Calendar auth tokens
      match /calendarAuth/{authId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }

      // Settings
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ==================== EXECUTED ACTIONS ====================
    match /executedActions/{actionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }

    // ==================== DENY ALL OTHER ====================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
