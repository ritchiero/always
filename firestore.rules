rules_version = "2";
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== HELPER FUNCTIONS ====================
    
    // User is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // User owns the document (via userId field)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Document has userId field matching authenticated user
    function belongsToUser() {
      return isAuthenticated() && 
             resource.data.userId == request.auth.uid;
    }
    
    // Incoming data will have correct userId
    function hasValidUserId() {
      return isAuthenticated() && 
             request.resource.data.userId == request.auth.uid;
    }
    
    // ==================== LEGACY RECORDINGS (ROOT LEVEL) ====================
    // ⚠️ MIGRATION NOTE: These should be moved to /users/{userId}/recordings
    
    match /recordings/{recordingId} {
      // Read: Only if document belongs to user
      allow read: if belongsToUser();
      
      // Create: Only if userId is set correctly
      allow create: if hasValidUserId();
      
      // Update: Only if user owns it AND doesn't change userId
      allow update: if belongsToUser() && 
                       request.resource.data.userId == resource.data.userId;
      
      // Delete: Only if user owns it
      allow delete: if belongsToUser();
    }
    
    // ==================== USER-SCOPED COLLECTIONS (RECOMMENDED) ====================
    
    match /users/{userId} {
      // User can read their own user doc
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
      
      // User profile
      match /profile/{profileId} {
        allow read, write: if isOwner(userId);
      }
      
      // Recordings (user-scoped)
      match /recordings/{recordingId} {
        allow read, write: if isOwner(userId);
      }
      
      // Checkpoints (silent session backups during recording)
      match /checkpoints/{checkpointId} {
        allow read, write: if isOwner(userId);
      }
      
      // Conversations (consolidated from recordings)
      match /conversations/{conversationId} {
        allow read: if isOwner(userId);
        // Write only from backend (Cloud Functions run with admin SDK, bypasses rules)
        // But allow user to update for marking as read, archiving, etc.
        allow write: if isOwner(userId);
      }
      
      // Daily summaries
      match /dailySummaries/{date} {
        allow read, write: if isOwner(userId);
      }
      
      // Calendar tokens & events
      match /calendar/{calendarId} {
        allow read, write: if isOwner(userId);
      }
      
      // Action items
      match /actionItems/{actionId} {
        allow read, write: if isOwner(userId);
      }
      
      // Settings
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ==================== DENY ALL OTHER COLLECTIONS ====================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
